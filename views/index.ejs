<!DOCTYPE html>
<html>
  <head>
    <title>WhatsApp Auto - Dashboard</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: Arial;
        background: #f5f5f5;
      }
      .navbar {
        background: #25d366;
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .navbar h2 {
        margin: 0;
      }
      .nav-links {
        display: flex;
        gap: 20px;
      }
      .nav-links a {
        color: white;
        text-decoration: none;
        cursor: pointer;
      }
      .nav-links a:hover {
        text-decoration: underline;
      }
      .logout-btn {
        background: #d32f2f;
        padding: 8px 15px;
        border-radius: 4px;
        cursor: pointer;
        border: none;
        color: white;
      }
      .logout-btn:hover {
        background: #b71c1c;
      }
      .container {
        max-width: 600px;
        margin: 30px auto;
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #25d366;
        margin-bottom: 20px;
      }
      .status {
        background: #e8f5e9;
        padding: 15px;
        border-radius: 5px;
        margin: 15px 0;
        border-left: 4px solid #25d366;
        white-space: pre-wrap; /* Ensures text wrapping for status */
      }
      .form-group {
        margin: 15px 0;
      }
      label {
        display: block;
        font-weight: bold;
        margin-bottom: 8px;
      }
      input,
      textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: Arial;
      }
      textarea {
        resize: vertical;
        min-height: 80px;
        white-space: pre-wrap; /* Ensures text wrapping */
      }
      button {
        background: #25d366;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
      }
      button:hover {
        background: #1fa857;
      }
      .hidden {
        display: none;
      }
      .login-container {
        max-width: 400px;
      }
      .pricing-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 20px 0;
      }
      .plan-card {
        border: 1px solid #ddd;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
      }
      .plan-card h3 {
        color: #25d366;
        margin-bottom: 10px;
      }
      .plan-card .price {
        font-size: 24px;
        font-weight: bold;
        color: #333;
        margin: 10px 0;
      }
      .alert {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        display: none;
        white-space: pre-wrap; /* Ensures text wrapping for alerts */
      }
      .alert.success {
        background: #c8e6c9;
        color: #2e7d32;
        display: block;
      }
      .alert.error {
        background: #ffcdd2;
        color: #c62828;
        display: block;
      }
    </style>
  </head>
  <body>
    <!-- Navigation Bar -->
    <div class="navbar" id="navbar" style="display: none">
      <h2>WhatsApp Auto Bot</h2>
      <div class="nav-links">
        <a onclick="showSection('dashboard')">Dashboard</a>
        <a onclick="showSection('settings')">Settings</a>
        <a onclick="showSection('plans')">Plans</a>
        <a id="qrTab" onclick="showQRTab()" style="display: none;">QR Code</a>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- Login Section -->
    <div class="container login-container" id="loginSection">
      <h1>WhatsApp Auto Bot - Login</h1>
      <div class="alert" id="loginAlert"></div>
      <form id="loginForm">
        <div class="form-group">
          <label>Client ID:</label>
          <input
            type="text"
            id="clientId"
            placeholder="Enter your client ID"
            required
          />
        </div>
        <div class="form-group">
          <label>Password:</label>
          <input
            type="password"
            id="password"
            placeholder="Enter password"
            required
          />
        </div>
        <button type="submit" style="width: 100%">Login</button>
      </form>

      <div class="form-group">
        <p></p>
          Don't have an account?
          <a
            onclick="showLoginTab('register')"
            style="color: #25d366; cursor: pointer"
            >Register here</a
          >
        </p>
      </div>

      <!-- Registration Form (hidden by default) -->
      <form id="registerForm" style="display: none">
        <h2>Create Account</h2>
        <div class="form-group">
          <label>Client ID:</label>
          <input
            type="text"
            id="regClientId"
            placeholder="Choose a client ID"
            required
          />
        </div>
        <div class="form-group">
          <label>Email:</label>
          <input
            type="email"
            id="regEmail"
            placeholder="Enter your email"
            required
          />
        </div>
        <div class="form-group">
          <label>Password:</label>
          <input
            type="password"
            id="regPassword"
            placeholder="Create a password"
            required
          />
        </div>
        <button type="submit" style="width: 100%">Register</button>
        <p>
          <a
            onclick="showLoginTab('login')"
            style="color: #25d366; cursor: pointer"
            >Back to Login</a
          >
        </p>
      </form>
    </div>

    <!-- Dashboard Section -->
    <div class="container hidden" id="dashboardSection">
      <h1>Dashboard</h1>
      <div class="status">Status: <strong id="status">Loading...</strong></div>
      <div class="status">
        Client ID: <strong id="currentClientId"></strong>
      </div>
    </div>

    <!-- Settings Section -->
    <div class="container hidden" id="settingsSection">
      <h1>Settings</h1>
      <div class="alert" id="settingsAlert"></div>
      <form id="configForm">
        <div class="form-group">
          <label>Auto Reply Message:</label>
          <textarea
            id="replyMessage"
            placeholder="Enter reply message"
          ></textarea>
        </div>

        <div class="form-group">
          <label>Message Delay (ms):</label>
          <input type="number" id="messageDelay" value="1000" />
        </div>

        <div class="form-group">
          <label>
            <input type="checkbox" id="autoReply" /> Enable Auto Reply
          </label>
        </div>

        <button type="submit" style="width: 100%">Save Settings</button>
      </form>
    </div>

    <!-- Plans Section -->
    <div class="container hidden" id="plansSection">
      <h1>Subscription Plans</h1>
      <div class="pricing-grid" id="plansGrid"></div>
    </div>

    <!-- QR Code Section -->
    <div id="qr-container" style="display: none;">
      <h3>Scan the QR Code</h3>
      <img id="qr-code" src="" alt="QR Code" />
    </div>

    <div class="container hidden" id="qrSection">
      <h1>QR Code</h1>
      <div id="qr-container" style="display: none;">
        <h3>Scan the QR Code</h3>
        <img id="qr-code" src="" alt="QR Code" />
      </div>
      <div id="qr-message" style="color: red; display: none;">QR code not available yet.</div>
    </div>

    <script>
      let currentClientId = null;

      // Login form submission
      document.getElementById("loginForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const clientId = document.getElementById("clientId").value;
        const password = document.getElementById("password").value;

        const response = await fetch("/api/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ clientId, password }),
        });

        const data = await response.json();
        const alert = document.getElementById("loginAlert");

        if (data.success) {
          currentClientId = clientId;
          alert.textContent = "Login successful!";
          alert.className = "alert success";
          setTimeout(() => {
            document.getElementById("loginSection").classList.add("hidden");
            document.getElementById("navbar").style.display = "flex";
            document.getElementById("currentClientId").textContent = clientId;
            document.getElementById("qrTab").style.display = "inline"; // Show QR Code tab
            showSection("dashboard");
            loadStatus();
            fetchQRCode();
          }, 1000);
        } else {
          alert.textContent = data.message || "Login failed!";
          alert.className = "alert error";
        }
      });

      // Show/Hide sections
      function showSection(section) {
        document
          .querySelectorAll(".container")
          .forEach((el) => el.classList.add("hidden"));
        document.getElementById(section + "Section").classList.remove("hidden");

        if (section === "plans") loadPlans();
        if (section === "settings") loadSettings();
      }

      // Load status
      async function loadStatus() {
        const response = await fetch("/api/status");
        const data = await response.json();
        document.getElementById("status").textContent = data.status;
      }

      // Load settings
      async function loadSettings() {
        const response = await fetch(`/api/client/${currentClientId}/config`);
        const config = await response.json();
        document.getElementById("replyMessage").value =
          config.replyMessage || "";
        document.getElementById("messageDelay").value =
          config.messageDelay || 1000;
        document.getElementById("autoReply").checked =
          config.autoReply || false;
      }

      // Save settings
      document
        .getElementById("configForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          await fetch(`/api/client/${currentClientId}/config`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              replyMessage: document.getElementById("replyMessage").value,
              messageDelay: parseInt(
                document.getElementById("messageDelay").value
              ),
              autoReply: document.getElementById("autoReply").checked,
            }),
          });
          const alert = document.getElementById("settingsAlert");
          alert.textContent = "Settings saved successfully!";
          alert.className = "alert success";
          setTimeout(() => alert.classList.remove("alert"), 3000);
        });

      // Load plans
      async function loadPlans() {
        const response = await fetch("/api/plans");
        const data = await response.json();
        const grid = document.getElementById("plansGrid");
        grid.innerHTML = Object.entries(data.plans)
          .map(
            ([name, plan]) => `
          <div class="plan-card">
            <h3>${name.charAt(0).toUpperCase() + name.slice(1)}</h3>
            <div class="price">$${plan.price}</div>
            <p>Messages: ${plan.messages}</p>
            <button onclick="selectPlan('${name}')">Select Plan</button>
          </div>
        `
          )
          .join("");
      }

      // Select plan
      function selectPlan(plan) {
        alert(`You selected: ${plan} plan`);
      }

      // Logout
      function logout() {
        currentClientId = null;
        document.getElementById("loginSection").classList.remove("hidden");
        document.getElementById("navbar").style.display = "none";
        document.getElementById("loginForm").reset();
        document.getElementById("qrTab").style.display = "none"; // Hide QR Code tab
      }

      // Show login or registration tab
      function showLoginTab(tab) {
        if (tab === "login") {
          document.getElementById("loginForm").style.display = "block";
          document.getElementById("registerForm").style.display = "none";
        } else {
          document.getElementById("loginForm").style.display = "none";
          document.getElementById("registerForm").style.display = "block";
        }
      }

      // Register form submission
      document.getElementById("registerForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const clientId = document.getElementById("regClientId").value;
        const email = document.getElementById("regEmail").value;
        const password = document.getElementById("regPassword").value;

        const response = await fetch("/api/register", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ clientId, email, password }),
        });

        const data = await response.json();
        const alert = document.getElementById("loginAlert");

        if (data.success) {
          alert.textContent = data.message;
          alert.className = "alert success";
          setTimeout(() => showLoginTab("login"), 2000);
        } else {
          alert.textContent = data.message;
          alert.className = "alert error";
        }
      });

      // Fetch QR Code
      async function fetchQRCode() {
                const clientId = document.getElementById("clientId").value;

        const response = await fetch(`/api/qr/${clientId}`);
        console.log(clientId)
        const data = await response.json();
        const qrContainer = document.getElementById("qr-container");
        const qrMessage = document.getElementById("qr-message");
        const qrCodeImg = document.getElementById("qr-code");

        if (data.success) {
          qrCodeImg.src = data.qrCode;
          qrContainer.style.display = "block";
          qrMessage.style.display = "none";
        } else {
          qrContainer.style.display = "none";
          qrMessage.style.display = "block";
          qrMessage.textContent = data.message;
        }
      }

      // Poll for QR code updates every 5 seconds
      setInterval(fetchQRCode, 5000);

      // Show QR Code tab
      function showQRTab() {
        showSection("qr");
        fetchQRCode(); // Fetch the QR code immediately when the tab is opened
      }
    </script>
  </body>
</html>
